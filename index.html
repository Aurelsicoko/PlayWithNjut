<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <link rel="stylesheet" href="css/index.css">
        <title>Play With Njut!</title>
    </head>
    <body>
        <section id="home">
            <video autoplay loop muted preload="metadata">
                <source src="./videos/video_essai.mp4" type="video/mp4">
            </video>
            <div class="content">
                <img id="logo"src="img/logo.png" alt="logo"/>
                <h1 class="normal">Créez votre musique en utilisant</h1>
                <h1 class="gras">les objets du quotidien !</h1>
                <div id="scan">
                    <h2>Scannez pour commencer l'expérience</h2>
                    <div id="qrcode"></div>
                </div>      
            </div>
        </section>
        
        <section id="end">
            <div id="container">
                <h1>Merci d'avoir joué avec</h1>
                <img id="logo"src="img/njut_seul.png" alt="logo"/>
            </div>
            <audio id="playerEnd" src="sounds/njut_ikea.mp3"></audio>    
        </section>

        <section id="jeu">
            <section class="baf">
                <div id="baf_droite">
                    <img src="img/baf_droite_haut.png" />
                    <img src="img/baf_droite_centre.png" />
                    <img src="img/baf_droite_bas.png" />
                </div>

                <div id="baf_gauche" >
                    <img src="img/baf_gauche_haut.png" />
                    <img src="img/baf_gauche_centre.png" />
                    <img src="img/baf_gauche_bas.png" />
                </div>
            </section>    
            <section class="foule">
                <div>
                    <img class="a" src="img/perso1.png" />
                    <img class="b" src="img/perso2.png" />
                    <img class="a" src="img/perso3.png" />
                    <img class="c" src="img/perso4.png" />
                    <img class="b" src="img/perso5.png" />
                </div>

                <div id="decal">
                    <img class="c" src="img/perso4.png" />
                    <img class="d" src="img/perso5.png" />
                    <img class="b" src="img/perso1.png" />
                    <img class="d" src="img/perso2.png" />
                    <img class="a" src="img/perso3.png" />
                </div>
            </section>    

            <audio id="player" src=""></audio>
            <video id="v" width="1000" height="700"></video>
            <canvas id="c" width="1000" style="z-index:2" height="700"></canvas>
            <div id="listimg"></div>
        </section>        


        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>   
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script> 
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script src="/js/player.js"></script>  
        <script src="/js/qrcode.min.js"></script> 
        <script src="/js/greenBackground.js"></script> 
        <script type="text/javascript">

            var place, playing, nbUser = 0;

            /* HTML Elements */
            var home = $('#home');
            var endSection = $('#end');
            var qrCodeSection = $('#qrcode');
            var canvas = $('canvas');
            var jeuSection = $('#jeu');

            /* CSS */
            $(jeuSection).addClass('noDisplay');
            $(endSection).addClass("noDisplay");


            /* Génération d'un QRCode pour accéder aux instruments sur mobile */
            var qrcode = new QRCode("qrcode");
            qrcode.makeCode("http://"+window.location.host+"/controller.html");

            /* Connexion au flux de socket */
            var socket = io.connect(); 

            /* On se connecte à la partie */
            socket.emit('connect', 'index');

            /* On récupère le lieu pour changer le background */
            socket.on('place', function(data){
                console.log("Lieu : "+data);
                place = data;
            });

            /* Initialisation du player audio général */
            player.init({
                file: '',
                initied : function(){
                    console.log("initied");
                    randMusic();                    
                },
                loaded : function(){
                    console.log("loaded");
                    player.play();
                },
                playing : function(){
                    console.log("playing");
                },
                pause : function(){
                    console.log("pause");
                },
                ended : function(){
                    console.log("Terminé");
                    playing = false;
                    socket.emit('end');

                    stopStream(); // On arrête la webcam
                    $(jeuSection).addClass("noDisplay"); // On cache l'environnement de jeu
                    $('#playerEnd')[0].play();
                    $(endSection).removeClass().addClass("fadeInDownBig").addClass("animated"); // On affiche la fin de la partie


                    setTimeout(function(){
                        $('#playerEnd').animate({volume: 0}, 2000, function(){
                            $('#playerEnd')[0].pause();
                            $('#playerEnd').currentTime = 0;
                        });
                        
                        nbUser = 0;
                        playing = true;
                        socket.emit("playing", playing);
                        randMusic();
                        $('audio:not(#player, #playerEnd)').remove();
                        $(jeuSection).removeClass().addClass('noDisplay');
                        $(endSection).removeClass().addClass("noDisplay");
                        $(home).removeClass().addClass("fadeInDownBig").addClass("animated");
                    }, 9000);
                }
            });

            /* On est bien connecté à la partie */
            socket.on('connected', function(){
                console.log("Connexion réussi avec le serveur");  
            });

            /* Un utilisateur arrive */
            socket.on('newUser', function(data){

                if(nbUser == 0){

                    $(home).removeClass().addClass("noDisplay"); // On cache la section home

                    initialize(function(){
                        $(canvas).addClass("noDisplay");
                        $(jeuSection).removeClass(); // On affiche l'environnement de jeu
                        player.load(); // On lance le player
                        playing = true;
                        socket.emit("playing", playing);
                    });
                }
                
                nbUser++;

                theId = data.id;
                theInstrument = data.instrument.toLowerCase();

                /* Création de player audio à la volée pour chaque utilisateur */
                var ifAudioPlayer = $('audio[id='+theId+']').length;
                if(ifAudioPlayer == 0){
                    $('body').append("<audio class='"+theId+"' src='sounds/"+theInstrument+".mp3'></audio>");
                    $('body').append("<audio class='"+theId+"' src='sounds/"+theInstrument+".mp3'></audio>");
                }    
            });


            socket.on('clicked', function(data){
                theId = data.id;
                theInstrument = data.instrument.toLowerCase();
                
                var playerAudioOne = $('audio[class='+theId+']')[0];
                //var playerAudioTwo = $('audio[class='+theId+']')[1];
                playerAudioOne.currentTime = 0;
                playerAudioOne.play();


                /* /!\ A AMELIORER /!\ 
                if(playerAudioOne.currentTime == 0){
                    console.log("Player 1");
                    $(playerAudioTwo).animate({volume: 0}, 500);
                    playerAudioOne.volume = 1;
                    //playerAudioOne.currentTime = 0; // A chaque fois que l'utilisateur joue, on remet son son à 0
                    playerAudioOne.play(); // Et on le joue
                }
                else{
                    console.log("Player 2");
                    $(playerAudioOne).animate({volume: 0}, 500);
                    playerAudioTwo.volume = 1;
                    playerAudioTwo.play();
                }*/
                

                console.log("On joue "+theInstrument);
            });

            socket.on('photo', function(photo) {
                /* Récupération taille de la fenêtre */
                var clientWidth = $(document).width();
                /* Création d'une div à la volée contenant l'avatar du membre qui a twittés */
                $('#listimg').append('<div><img src="'+photo+'" /></div>');

                var theDiv = $('#listimg div:last-of-type');
                /* Calcul du nombre aléatoire pour déterminer la position du pin */
                var divWidth = $(theDiv).width();
                var posX = Math.floor(Math.random() * (clientWidth-divWidth)) + divWidth;
                /* Positionnement du pin */
                $('#listimg div:last-of-type').css({left:posX});
                /* Mise en place de la disparition du pin après 5s */
                var self = $('#listimg div:last-of-type');
                setTimeout(function(){
                    $(self).fadeOut(500, function(){
                        $(this).remove();
                    });
                }, 5000);
            });

            function randMusic(){
                $.getJSON("/js/musics.json", function(data){
                    var nb = Math.floor(Math.random() * 3);
                    var i = 0;
                    $.each(data, function(key,val){
                        if(i == nb)
                            player.setFile('sounds/'+val.title+'.mp3');

                        i++;
                    });
                }); 
            }

        </script>
        <script src="/js/fullscreen.js"></script>
    </body>
</html>
